# Отчётный файл по проекту «Подсчёт людей в магазине»

Ниже — расширенное описание проекта по пунктам.

## 1) Ознакомление с вариантом
**Вариант:** «Подсчёт людей в магазине».  
**Цель:** автоматически определять количество людей на изображениях/видео/потоках и показывать результаты в веб‑интерфейсе.

**Описание предметной области:**
Подсчёт посетителей используется для оценки загруженности магазина, анализа трафика, контроля очередей и планирования персонала.  
Вручную такие данные собирать сложно и дорого, поэтому задача автоматизации актуальна.

**Ограничения и ожидания:**
- нужны быстрые ответы (интерактивный режим);
- допускается небольшая погрешность;
- система должна работать с разными типами входных данных (изображение, видео, поток по URL).

## 2) Подбор архитектуры нейронной сети
Для задачи детекции людей выбрана архитектура **YOLOv8** (вариант **YOLOv8n** как лёгкая и быстрая модель).  

**Причины выбора:**
- высокая скорость инференса на CPU;
- приемлемая точность для подсчёта людей;
- готовые веса и удобная интеграция через библиотеку Ultralytics;
- возможность получить bounding‑boxes для дальнейшего подсчёта.

**Почему именно YOLOv8n:**
Это самая лёгкая версия семейства YOLOv8, что важно для веб‑приложения без выделенного GPU.  
В случае необходимости можно заменить модель на более точную (YOLOv8s/m/l/x).

## 3) Реализация веб‑интерфейса
Сделано веб‑приложение на базе **FastAPI** с HTML/JS‑интерфейсом:

**Функциональность:**
- загрузка **изображений** и мгновенный вывод результата;
- загрузка **видео** и показ результата по мере обработки (как поток);
- обработка **потока по URL** (RTSP/HTTP);
- кнопка запуска обработки;
- отображение статистики и визуальных результатов (боксы, счётчик).

**Реализация UI:**
- `web/index.html` — структура вкладок и блоков;
- `web/styles.css` — оформление интерфейса;
- `web/app.js` — логика отправки запросов и отображения результатов.

**Особенности:**
- отдельная вкладка «История»;
- результаты для каждого режима независимы;
- обработанный поток может открываться в отдельной вкладке браузера (MJPEG);
- вкладка «Поток» может быть отключена в интерфейсе (если поток не используется).

## 4) Интеграция предобученной модели
Использована библиотека **Ultralytics** с моделью **YOLOv8n** (`yolov8n.pt`).  

**Как интегрировано:**
- загрузка модели при старте приложения (`app/detector.py`);
- вход — кадр изображения (numpy array);
- выход — список боксов + количество людей.

**Обработка кадров:**
- фильтрация классов (используется только класс «person»);
- отрисовка bounding‑boxes на изображении;
- кодирование результата для передачи на фронтенд.

**Порог уверенности:**
значение задаётся через параметр `conf` (по умолчанию 0.25).

## 5) Вывод статистики и история запросов
Реализовано:
- сохранение истории запросов в **JSON** (`data/history.json`);
- запись в историю:
  - **изображения:** имя файла, количество людей;
  - **видео:** имя файла, длительность, максимальное количество людей;
  - **временная метка** запроса.
- вывод истории в веб‑интерфейсе (вкладка «История») в виде таблицы;
- экспорт истории в **Excel** через эндпоинт `/api/history/excel`.

**Логика хранения:**
- записи добавляются в конец списка;
- файл перезаписывается целиком (подходит для небольшого объёма данных).


---

### Дополнительные сведения
- Backend: **FastAPI** (`app/main.py`, `app/jobs.py`)
- Детектор: **Ultralytics YOLOv8** (`app/detector.py`)
- История: `app/history.py`, `data/history.json`
- Веб‑часть: `web/`

### Описание Python‑файлов проекта
- `app/main.py` — основной вход FastAPI: роуты для обработки изображений/видео/потоков, отдача результатов, MJPEG‑стрим и история.
- `app/jobs.py` — асинхронная обработка видео/потоков, управление задачами, рассылка статусов по WebSocket, генерация кадров для MJPEG и финального видео.
- `app/detector.py` — загрузка модели YOLOv8, детекция людей, отрисовка боксов и кодирование кадров.
- `app/history.py` — чтение/запись истории запросов в `data/history.json` и экспорт в Excel.
